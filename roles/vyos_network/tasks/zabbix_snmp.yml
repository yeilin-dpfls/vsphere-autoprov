# roles/vyos_network/tasks/zabbix_snmp.yml
---
- name: 1. Configure SNMP Community and Details
  vyos.vyos.vyos_config:
    lines:
      # SNMP ì½ê¸° ì „ìš©(ro) ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
      - set service snmp community ZABBIX authorization ro
      - set service snmp community ZABBIX network 0.0.0.0/0
      - set service snmp contact "Project Monitoring Admin"
      - set service snmp location "Project Lab Environment"

- name: 2. Allow Zabbix Server to access SNMP (161/UDP)
  # VyOS ìì²´(local)ë¡œ ë“¤ì–´ì˜¤ëŠ” SNMP íŠ¸ë˜í”½ í—ˆìš©
  vyos.vyos.vyos_config:
    lines:
      # VyOS ìì²´ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ (local)ì— ëŒ€í•œ ë°©í™”ë²½ ê·œì¹™ ì •ì˜
      - set firewall name LOCAL_IN_MONITOR default-action drop
      - set firewall name LOCAL_IN_MONITOR rule 10 action accept
      - set firewall name LOCAL_IN_MONITOR rule 10 destination port 161
      - set firewall name LOCAL_IN_MONITOR rule 10 protocol udp
      # Zabbix Server IPë§Œ SNMP í¬íŠ¸ë¡œ ì ‘ê·¼ í—ˆìš©
      - set firewall name LOCAL_IN_MONITOR rule 10 source address {{ zabbix_ip }}
      - set interfaces ethernet eth2 firewall local name LOCAL_IN_MONITOR

# -----------------------------------------------------
# 3. ğŸš¨ OUTSIDE -> INSIDE í¬ì›Œë”© ê·œì¹™ ì¶”ê°€ (Ping ë° Web ì ‘ì† í•´ê²°)
# -----------------------------------------------------
- name: 3. Configure Forwarding Rules for Internal VLANs (Outside to Inside)
  vyos.vyos.vyos_config:
    lines:
      # ğŸš¨ í¬ì›Œë”© ë°©í™”ë²½ ê·œì¹™ ìƒì„± (OUTSIDE_TO_INSIDE)
      - set firewall name OUTSIDE_TO_INSIDE default-action drop
      
      # ğŸš¨ Rule 10: HTTP (ì›¹ ì ‘ì†) í—ˆìš© ê·œì¹™ ì¶”ê°€
      - set firewall name OUTSIDE_TO_INSIDE rule 10 action accept
      - set firewall name OUTSIDE_TO_INSIDE rule 10 destination port 80
      - set firewall name OUTSIDE_TO_INSIDE rule 10 protocol tcp
      - set firewall name OUTSIDE_TO_INSIDE rule 10 state new enable

      # ğŸš¨ Rule 11: ICMP (Ping) í—ˆìš© ê·œì¹™ ì¶”ê°€ (ìƒˆë¡œìš´ ê·œì¹™ìœ¼ë¡œ ë¶„ë¦¬)
      - set firewall name OUTSIDE_TO_INSIDE rule 11 action accept
      - set firewall name OUTSIDE_TO_INSIDE rule 11 protocol icmp
      - set firewall name OUTSIDE_TO_INSIDE rule 11 state new enable
      
      # ğŸš¨ Rule 20: Established/Related íŠ¸ë˜í”½ í—ˆìš© (í•„ìˆ˜)
      - set firewall name OUTSIDE_TO_INSIDE rule 20 action accept
      - set firewall name OUTSIDE_TO_INSIDE rule 20 state established enable
      - set firewall name OUTSIDE_TO_INSIDE rule 20 state related enable

      # ëª¨ë“  ì™¸ë¶€ IP í—ˆìš©
      - set firewall name OUTSIDE_TO_INSIDE rule 10 source address 0.0.0.0/0
      - set firewall name OUTSIDE_TO_INSIDE rule 11 source address 0.0.0.0/0
      - set firewall name OUTSIDE_TO_INSIDE rule 20 source address 0.0.0.0/0
      

      # ğŸš¨ eth1 (Outside) ì¸í„°í˜ì´ìŠ¤ì— 'in' ê·œì¹™ìœ¼ë¡œ í¬ì›Œë”© ì ìš©
      - set interfaces ethernet eth1 firewall in name OUTSIDE_TO_INSIDE

# -----------------------------------------------------
# 4. Commit and Save VyOS Configuration (í†µí•©)
# -----------------------------------------------------
- name: 4. Commit and Save VyOS Configuration
  vyos.vyos.vyos_config:
    save: yes 
