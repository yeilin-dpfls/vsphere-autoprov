---
- name: üö® Wait for Guest Operations Agent to initialize
  ansible.builtin.pause:
    seconds: 60
    prompt: "Waiting for Guest Operations readiness..."
  delegate_to: localhost

- name: 1. Configure VyOS Network, Routing, and NAT (DHCP-based)
  community.vmware.vmware_vm_shell:
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: 'false'
      datacenter: '{{ vcenter_datacenter }}'
      folder: "{{ vcenter_folder }}" 
      vm_id: '{{ vyos_vm_name }}'      
      vm_id_type: vm_name
      
      vm_username: '{{ vyos_os_user }}' 
      vm_password: '{{ vyos_ssh_pass }}' 
      
      vm_shell: /bin/vbash
      
      vm_shell_args: |-
        -c "source /opt/vyatta/etc/functions/script-template
        configure
        
        # 1. SSH ÏÑ§Ï†ï
        set service ssh port {{ vyos_ssh_port }}
        
        # 2. eth1 = VM Network (Outside) - IP 2Í∞ú Ìï†Îãπ
        set interfaces ethernet eth1 address 10.10.10.111/8
        set interfaces ethernet eth1 address 10.10.10.120/8
        set interfaces ethernet eth1 address 10.10.10.130/8
        set interfaces ethernet eth1 address 10.10.10.190/8
        set interfaces ethernet eth1 description 'Outside-Management'
        
        # 3. eth2 = DVS Ìè¨Ìä∏Í∑∏Î£π (Inside, VLAN Trunk)
        set interfaces ethernet eth2 description 'Inside-Trunk-DVS'
        
        # VLAN 4094 ÏÑúÎ∏å Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
        set interfaces ethernet eth2 vif 4094 address {{ vyos_gw_vlan4094 }}
        set interfaces ethernet eth2 vif 4094 description 'VLAN_4094_Base'
        
        # VLAN 90 (Manage)
        set interfaces ethernet eth2 vif {{ vlan_manage }} address {{ vyos_gw_vlan90 }}
        set interfaces ethernet eth2 vif {{ vlan_manage }} description 'VLAN_90_Manage' 
        
        # VLAN 20 (Mail)
        set interfaces ethernet eth2 vif {{ vlan_mail_server }} address {{ vyos_gw_vlan20 }} 
        set interfaces ethernet eth2 vif {{ vlan_mail_server }} description 'VLAN_20_Mail'
        
        # VLAN 30 (Nginx)
        set interfaces ethernet eth2 vif {{ vlan_nginx_server }} address {{ vyos_gw_vlan30 }}
        set interfaces ethernet eth2 vif {{ vlan_nginx_server }} description 'VLAN_30_Nginx'
        
        # 4. ÎùºÏö∞ÌåÖ
        set protocols static route 0.0.0.0/0 next-hop {{ vyos_default_gateway }}
        
        # 5. NAT (SNAT) - Inside ‚Üí Outside
        set nat source rule 100 outbound-interface eth1
        set nat source rule 100 source address 172.16.3.0/24
        set nat source rule 100 translation address masquerade
        
        set nat source rule 200 outbound-interface eth1
        set nat source rule 200 source address 172.16.2.0/24
        set nat source rule 200 translation address masquerade

        set nat source rule 300 outbound-interface eth1
        set nat source rule 300 source address 172.16.3.0/24
        set nat source rule 300 translation address masquerade
        
        # 6. DNAT - 10.10.10.120 ‚Üí Mail Server (172.16.2.100)
        set nat destination rule 120 description 'DNAT-to-Mail-Server'
        set nat destination rule 120 inbound-interface eth1
        set nat destination rule 120 destination address 10.10.10.120
        set nat destination rule 120 translation address 172.16.2.100
        
        # 7. DNAT - 10.10.10.130 ‚Üí Nginx Server (172.16.3.100)
        set nat destination rule 130 description 'DNAT-to-Nginx-Server'
        set nat destination rule 130 inbound-interface eth1
        set nat destination rule 130 destination address 10.10.10.130
        set nat destination rule 130 translation address 172.16.3.100

        # 8. DNAT - 10.10.10.190 Zabbix(172.16.9.100)
        set nat destination rule 190 description 'DNAT-to-Zabbix'
        set nat destination rule 190 inbound-interface eth1
        set nat destination rule 190 destination address 10.10.10.190
        set nat destination rule 190 translation address 172.16.9.100
        #set nat destination rule 190 destination port 80
        #set nat destination rule 190 translation port 80
        
        # 8. DNS/NTP
        set system name-server 8.8.8.8
        set system ntp server kr.pool.ntp.org
        
        commit
        save"
      wait_for_process: true
      timeout: 240
  delegate_to: localhost
  register: vyos_shell_config

- name: Display VyOS configuration result
  debug:
    var: vyos_shell_config
