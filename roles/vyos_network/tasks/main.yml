# /root/autoprov/vsphere-autoprov/roles/vyos_network/tasks/main.yml
---
- name: ğŸš¨ Wait for Guest Operations Agent to initialize
  ansible.builtin.pause:
    seconds: 60  # â­ 30 â†’ 60ìœ¼ë¡œ ë³€ê²½
    prompt: "Waiting for Guest Operations readiness..."
  delegate_to: localhost

- name: 1. Configure VyOS Network, Routing, and NAT (DHCP-based)
  community.vmware.vmware_vm_shell:
      # VCSA ì ‘ì† ì •ë³´
      hostname: '{{ vcenter_hostname }}'
      username: '{{ vcenter_username }}'
      password: '{{ vcenter_password }}'
      validate_certs: 'false'
      datacenter: '{{ vcenter_datacenter }}'
      folder: "{{ vcenter_folder }}" 
      vm_id: '{{ vyos_vm_name }}'      
      vm_id_type: vm_name
      
      # VyOS ì´ˆê¸° ì ‘ê·¼ ì •ë³´
      vm_username: '{{ vyos_os_user }}' 
      vm_password: '{{ vyos_ssh_pass }}' 
      
      # ì‹¤í–‰ ì‰˜
      vm_shell: /bin/vbash
      
      # VyOS ì„¤ì • ëª…ë ¹ ì£¼ì…
      vm_shell_args: |-
        -c "source /opt/vyatta/etc/functions/script-template
        configure
        
        # 1. ê´€ë¦¬ì ê³„ì • ë¹„ë°€ë²ˆí˜¸ ë° SSH ì„¤ì • (í–¥í›„ Playbookì„ ìœ„í•œ í•„ìˆ˜ ì„¤ì •)
        set service ssh port {{ vyos_ssh_port }}
        
        # 2. Outside NIC ì„¤ì • (eth2: Control Node í†µì‹ ìš©)
        set interfaces ethernet eth1 address dhcp
        set interfaces ethernet eth1 description 'Outside (DHCP)'
        
        # 3. Inside NIC ì„¤ì • (eth1: DVS íŠ¸ë í¬, VLAN ê¸°ë°˜ ì„œë¸Œ ì¸í„°í˜ì´ìŠ¤)
        set interfaces ethernet eth2 description 'Inside Trunk'
        set interfaces ethernet eth2 vif 4094 address {{ vyos_gw_vlan4094 }}
        set interfaces ethernet eth2 vif 4094 description 'VLAN_4904_Base'
        
        # VLAN 90 (Manage) ì„œë¸Œ ì¸í„°í˜ì´ìŠ¤ ì„¤ì •
        set interfaces ethernet eth2 vif {{ vlan_manage }} address {{ vyos_gw_vlan90 }}
        set interfaces ethernet eth2 vif {{ vlan_manage }} description 'VLAN_90_Manage' 
        
        # VLAN 20 (Mail Server) ì„œë¸Œ ì¸í„°í˜ì´ìŠ¤ ì„¤ì •
        set interfaces ethernet eth2 vif {{ vlan_mail_server }} address {{ vyos_gw_vlan20 }} 
        set interfaces ethernet eth2 vif {{ vlan_mail_server }} description 'VLAN_20_Mail_GW'
        
        # VLAN 30 (Nginx Server) ì„œë¸Œ ì¸í„°í˜ì´ìŠ¤ ì„¤ì •
        set interfaces ethernet eth2 vif {{ vlan_nginx_server }} address {{ vyos_gw_vlan30 }}
        set interfaces ethernet eth2 vif {{ vlan_nginx_server }} description 'VLAN_30_Nginx_GW'
        
        # 4. ë¼ìš°íŒ… ë° NAT ì„¤ì •
        set protocols static route 0.0.0.0/0 next-hop {{ vyos_default_gateway }}
        set nat source rule 100 outbound-interface eth1
        set nat source rule 100 source address 172.16.3.0/24
        set nat source rule 100 translation address masquerade

        set nat source rule 200 outbound-interface eth1
        set nat source rule 200 source address 172.16.2.0/24
        set nat source rule 200 translation address masquerade
        
        # 5. DNS ë° NTP ì„¤ì •
        set system name-server 8.8.8.8
        set system ntp server kr.pool.ntp.org

        commit
        save"
      wait_for_process: True
      timeout: 240

  delegate_to: localhost
  register: vyos_shell_config

