- name: Install and configure Postfix and Dovecot mail server with SSH key distribution
  hosts: mailservers
  become: yes
  vars:
    mail_hostname: "mail.psh.ke"
    mail_domain: "psh.ke"
    user_name: "test"
    user_password: "VMware1!"
    ssh_pub_key_path: "~/.ssh/id_rsa.pub"

  tasks:
    - name: Install postfix and dovecot
      dnf:
        name:
          - postfix
          - dovecot
        state: present
    - name: Set DNS to 10.10.53.1 in resolv.conf
      lineinfile:
        path: /etc/resolv.conf
        regexp: '^nameserver'
        line: 'nameserver 10.10.53.1'
      become: yes
    - name: Configure /etc/postfix/main.cf
      copy:
        dest: /etc/postfix/main.cf
        content: |
          myhostname = {{ mail_hostname }}
          mydomain = {{ mail_domain }}
          myorigin = $mydomain
          inet_interfaces = all
          inet_protocols = ipv4
          mydestination = $myhostname, localhost, $mail_domain, localhost, $mail_domain
          relayhost =
          mynetworks = 0.0.0.0/0
          home_mailbox = Maildir/

    - name: Set protocols in /etc/dovecot/dovecot.conf
      lineinfile:
        path: /etc/dovecot/dovecot.conf
        regexp: '^#?protocols ='
        line: 'protocols = imap pop3 lmtp submission'

    - name: Set listen in /etc/dovecot/dovecot.conf
      lineinfile:
        path: /etc/dovecot/dovecot.conf
        regexp: '^#?listen ='
        line: 'listen = *, ::'

    - name: Set base_dir in /etc/dovecot/dovecot.conf
      lineinfile:
        path: /etc/dovecot/dovecot.conf
        regexp: '^#?base_dir ='
        line: 'base_dir = /var/run/dovecot'

    - name: Configure mail_location in /etc/dovecot/conf.d/10-mail.conf
      lineinfile:
        path: /etc/dovecot/conf.d/10-mail.conf
        regexp: '^#?mail_location ='
        line: 'mail_location = maildir:~/Maildir'

    - name: Disable plaintext auth restriction in /etc/dovecot/conf.d/10-auth.conf
      lineinfile:
        path: /etc/dovecot/conf.d/10-auth.conf
        regexp: '^disable_plaintext_auth ='
        line: 'disable_plaintext_auth = no'

    - name: Disable SSL in /etc/dovecot/conf.d/10-ssl.conf
      lineinfile:
        path: /etc/dovecot/conf.d/10-ssl.conf
        regexp: '^#?ssl ='
        line: 'ssl = no'

    - name: Enable and start postfix
      systemd:
        name: postfix
        enabled: yes
        state: started

    - name: Enable and start dovecot
      systemd:
        name: dovecot
        enabled: yes
        state: started

    - name: Create user with password
      user:
        name: "{{ user_name }}"
        password: "{{ user_password | password_hash('sha512') }}"
        state: present
        shell: /bin/bash
        create_home: yes

    - name: Distribute SSH public key to user authorized_keys
      authorized_key:
        user: "{{ user_name }}"
        state: present
        key: "{{ lookup('file', ssh_pub_key_path) }}"

    - name: Restart postfix service
      systemd:
        name: postfix
        state: restarted

    - name: Restart dovecot service
      systemd:
        name: dovecot
        state: restarted
