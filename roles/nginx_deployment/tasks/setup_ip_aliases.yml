---
# 0.0. main_interface ë³€ìˆ˜ í•˜ë“œì½”ë”©
- name: 0.0. main_interface ë³€ìˆ˜ í•˜ë“œì½”ë”©
  ansible.builtin.set_fact:
    main_interface: "ens34"

# 0.1. alias_ip ë³€ìˆ˜ ì •ì˜ (ê¸°ì¡´ ìœ ì§€)
- name: 0.1. alias IP ë³€ìˆ˜ ì„¤ì • (group_varsì˜ ì™¸ë¶€ IP ì‚¬ìš©)
  ansible.builtin.set_fact:
    alias_ip_2: "{{ nginx_dnat_external_ip_2 }}"
    alias_ip_3: "{{ nginx_dnat_external_ip_3 }}"

# 0.2. internal_ip ë³€ìˆ˜ ì •ì˜ (ê¸°ì¡´ ìœ ì§€)
- name: 0.2. internal IP ë³€ìˆ˜ ì„¤ì • (backend_web_servers ê·¸ë£¹ì˜ IP ì‚¬ìš©)
  ansible.builtin.set_fact:
    internal_ip_2: "{{ hostvars['nginx-backend-02']['ansible_host'] }}"
    internal_ip_3: "{{ hostvars['nginx-backend-03']['ansible_host'] }}"


# ðŸŒŸ [ìˆ˜ì •] 1.3. ifconfig ë‘ ëª…ë ¹ì–´ë¥¼ í•˜ë‚˜ì˜ shell íƒœìŠ¤í¬ì— ë°•ì•„ ë„£ê¸°
- name: 1.3. Alias IP 2, 3 ì¦‰ì‹œ ì„¤ì • (ifconfig ì‰˜ ì—°ê²°)
  ansible.builtin.shell: ifconfig ens34:2 172.16.3.2; ifconfig ens34:3 172.16.3.3
  become: true
  ignore_errors: yes

# (2.1 ~ 2.3 íƒœìŠ¤í¬ëŠ” ë³€ê²½ ì—†ìŒ)
- name: 2.1. IP í¬ì›Œë”© í™œì„±í™” (ìž¬ë¶€íŒ… í›„ ìœ ì§€)
  ansible.builtin.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

- name: 2.2. SSH (TCP 22) DNAT ê·œì¹™ ì¶”ê°€ ({{ alias_ip_2 }} -> {{ internal_ip_2 }})
  ansible.builtin.command: >
    sudo iptables -t nat -A PREROUTING -d {{ alias_ip_2 }} -j DNAT --to-destination {{ internal_ip_2 }}
  ignore_errors: yes

- name: 2.3. SSH (TCP 22) DNAT ê·œì¹™ ì¶”ê°€ ({{ alias_ip_3 }} -> {{ internal_ip_3 }})
  ansible.builtin.command: >
    sudo iptables -t nat -A PREROUTING -d {{ alias_ip_3 }} -j DNAT --to-destination {{ internal_ip_3 }}
  ignore_errors: yes

# 2.4. ðŸ’¾ IPTables ê·œì¹™ ì˜êµ¬ ì €ìž¥ (ëª…ë ¹ì–´ ê·¸ëŒ€ë¡œ ìœ ì§€)
- name: 2.4. ðŸ’¾ IPTables ê·œì¹™ ì˜êµ¬ ì €ìž¥ (í•µì‹¬)
  ansible.builtin.shell: iptables-save > /etc/sysconfig/iptables
  become: true
