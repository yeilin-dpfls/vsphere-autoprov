---
# roles/nginx_deployment/tasks/configure.yml

# ----------------------------------------------------------------------
# 1. Nginx 설정 파일 배포 (notify 파라미터 제거)
#    : notify가 없으므로, 이 태스크가 'changed' 상태가 되어도 핸들러를 호출하지 않음
# ----------------------------------------------------------------------
- name: Deploy Nginx default config from template (no restart)
  ansible.builtin.template:   # <- name: 보다 공백 2칸
    src: default.conf.j2      # <- template: 보다 공백 2칸 (총 4칸)
    dest: "{{ nginx_conf_path }}"
    owner: root
    group: root
    mode: '0644'
  register: nginx_config_deployment
  notify: Restart Nginx service
# ----------------------------------------------------------------------
# 2. Nginx 설정이 변경되었으면 재시작을 강제로 수행
#    : 위 태스크가 변경(changed)되었을 때만 재시작하도록 'when' 조건 추가 가능
#    (이 태스크는 이전 태스크의 'changed' 상태를 직접 검사해야 함)
#    - 재시작 핸들러를 사용하는 것이 복잡하면, 아래처럼 restart 태스크를 추가합니다.
# ----------------------------------------------------------------------
- name: Restart Nginx service if config was changed
  ansible.builtin.service:
    name: nginx
    state: reloaded
  when:
    - nginx_config_deployment is defined
    - nginx_config_deployment.changed
  # 참고: 이전 태스크에 'register: nginx_config_deployment'를 추가해야 이 변수 사용 가능

# ----------------------------------------------------------------------
# 3. Nginx 웹 루트 디렉토리 생성 (이전과 동일)
# ----------------------------------------------------------------------
- name: Ensure Nginx webroot exists
  ansible.builtin.file:
    path: "{{ nginx_root_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

# ----------------------------------------------------------------------
# 4. index.html 파일 배포 (이전과 동일)
# ----------------------------------------------------------------------
- name: Ensure a simple index.html exists (do not overwrite if present)
  ansible.builtin.copy:
    dest: "{{ nginx_root_path }}/{{ nginx_index_file }}"
    content: |
      <html>
      <head>
          <title>Welcome to nginx!</title>
      </head>
      <body>
      <h1>Welcome to nginx!</h1>
      <p>If you see this page, the nginx web server is successfully installed and working. Further configuration is required.</p>

      <p>For online documentation and support please refer to
      <a href="http://nginx.org/">nginx.org</a>.<br/>
      Commercial support is available at
      <a href="http://nginx.com/">nginx.com</a>.</p>

      <p><em>Thank you for using nginx.</em></p>
      </body>
      </html>
    owner: root
    group: root
    mode: '0644'
    force: yes
