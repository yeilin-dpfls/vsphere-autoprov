---
# roles/nginx_deployment/tasks/install.yml
# Assumes the play sets `gather_facts: yes` and `become: yes`.

# 1) ì•ˆì „í•˜ê²Œ factsê°€ ì—†ìœ¼ë©´ ìˆ˜ì§‘ (í”Œë ˆì´ì—ì„œ gather_facts: yesì´ë©´ ë³´í†µ ê±´ë„ˆëœ€)
- name: Ensure facts are gathered
  ansible.builtin.setup:
  when: ansible_facts is not defined

# 2) apt ìºì‹œ ì—…ë°ì´íŠ¸ (Debian ê³„ì—´)
- name: Ensure apt cache is updated (Debian family)
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_facts.os_family | default('') == 'Debian'

# 3) EPEL (RHEL ê³„ì—´)
- name: Ensure EPEL repository is present (RHEL family)
  ansible.builtin.yum:
    name: epel-release
    state: present
  when: ansible_facts.os_family | default('') == 'RedHat'

# 4) Nginx ì„¤ì¹˜ (íŒ¨í‚¤ì§€ ëª¨ë“ˆ ì‚¬ìš© â€” í”Œë«í¼ ë¬´ê´€)
- name: Install Nginx package (cross-platform)
  ansible.builtin.package:
    name: "{{ nginx_package_name }}"
    state: present

# 5) ë°©í™”ë²½ ì„¤ì • â€” firewalld (RHEL) ë˜ëŠ” ufw (Debian) (best-effort)
- name: Allow HTTP (80) port through firewalld (RHEL family) if available
  ansible.builtin.firewalld:
    service: http
    permanent: true
    state: enabled
    immediate: true
  when: ansible_facts.os_family | default('') == 'RedHat'
  ignore_errors: true

# 5-B) RHEL ê³„ì—´ (firewalld) - HTTPS (443) í—ˆìš© (ğŸ”¥ ì¶”ê°€ë¨)
- name: Allow HTTPS (443) port through firewalld (RHEL family)
  ansible.builtin.firewalld:
    port: 443/tcp
    permanent: true
    state: enabled
    immediate: true
  when: ansible_facts.os_family | default('') == 'RedHat'
  ignore_errors: true

- name: Ensure UFW allows 80 (Debian/Ubuntu with ufw) (best-effort)
  ansible.builtin.command: ufw allow 80/tcp
  when: ansible_facts.os_family | default('') == 'Debian'
  changed_when: false
  ignore_errors: true

# 5-D) Debian ê³„ì—´ (ufw) - HTTPS (443) í—ˆìš© (ğŸ”¥ ì¶”ê°€ë¨)
- name: Ensure UFW allows 443 (Debian/Ubuntu with ufw)
  ansible.builtin.command: ufw allow 443/tcp
  when: ansible_facts.os_family | default('') == 'Debian'
  changed_when: false
  ignore_errors: true

# 6) ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘ â€” systemdê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ignore_errors ì‚¬ìš©
- name: Ensure Nginx service is enabled and started (systemd)
  ansible.builtin.systemd:
    name: "{{ nginx_service_name }}"
    enabled: true
    state: started
  ignore_errors: true

# 7) ë ˆê±°ì‹œ init/systemV í™˜ê²½ì„ ìœ„í•œ fallback (optional)
- name: Ensure Nginx service is started using service module (fallback)
  ansible.builtin.service:
    name: "{{ nginx_service_name }}"
    state: started
    enabled: yes
  when: ansible_facts.pkg_mgr is defined
  ignore_errors: true

# 8) ê²€ì¦
- name: Debug nginx binary/version (sanity)
  ansible.builtin.command: nginx -v
  register: nginx_ver
  changed_when: false
  failed_when: false

- name: Show nginx version output
  ansible.builtin.debug:
    var: nginx_ver.stderr  # nginx -v writes to stderr

