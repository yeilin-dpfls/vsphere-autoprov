# roles/nginx_deployment/tasks/dnat_ssh_mapping.yml ìˆ˜ì •ë³¸
---
- name: ğŸš€ Nginx ì„œë²„ì— firewalld ê¸°ë°˜ DNAT (í¬íŠ¸ í¬ì›Œë”©) ê·œì¹™ ì¶”ê°€
  # hosts.iniì˜ [linux_server] ê·¸ë£¹ì„ íƒ€ê²Ÿìœ¼ë¡œ ì§€ì •í•©ë‹ˆë‹¤.
  hosts: linux_server
  become: true

  vars:
    dnat_protocol: "tcp"
    dnat_port: "22" 
    
    # âš ï¸ [ìˆ˜ì • í•„ìš”] group_vars/all.ymlì— ì´ ë³€ìˆ˜ê°€ ì—†ìœ¼ë¯€ë¡œ, DNAT ì™¸ë¶€ IPëŠ” Playbook ë‚´ì—ì„œ í•˜ë“œì½”ë”©í•´ì•¼ í•©ë‹ˆë‹¤.
    # Nginx ens34 NICì— í• ë‹¹ë /í• ë‹¹ëœ ê°€ìƒ IPë¡œ ê°€ì •í•˜ê³  í•˜ë“œì½”ë”©í•©ë‹ˆë‹¤.
    external_ip_2: "172.16.3.2" 
    external_ip_3: "172.16.3.3"
    
    # [â­ ìˆ˜ì •] group_varsì˜ ë³€ìˆ˜ë¥¼ ì°¸ì¡°í•˜ê³  ì„œë¸Œë„· ë§ˆìŠ¤í¬('/24')ë¥¼ ì œê±°í•˜ì—¬ IP ì£¼ì†Œë§Œ ì¶”ì¶œí•©ë‹ˆë‹¤.
    internal_ip_2: "{{ nginx_backend_02_ip | split('/') | first }}" # -> "192.168.130.2"
    internal_ip_3: "{{ nginx_backend_03_ip | split('/') | first }}" # -> "192.168.130.3"

  tasks:
    - name: 1. Public Zoneì— Masquerade í™œì„±í™” (DNATë¥¼ ìœ„í•´ í•„ìˆ˜)
      ansible.builtin.command: sudo firewall-cmd --zone=public --add-masquerade --permanent
      # already set ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
      ignore_errors: yes

    - name: 2. SSH DNAT ({{ external_ip_2 }} -> {{ internal_ip_2 }}) ì¶”ê°€
      ansible.builtin.command: >
        sudo firewall-cmd 
        --zone=public 
        --add-forward-port=port={{ dnat_port }}:proto={{ dnat_protocol }}:toport={{ dnat_port }}:toaddr={{ internal_ip_2 }}
        --permanent
        --destination-address={{ external_ip_2 }} 
      ignore_errors: yes

    - name: 3. SSH DNAT ({{ external_ip_3 }} -> {{ internal_ip_3 }}) ì¶”ê°€
      ansible.builtin.command: >
        sudo firewall-cmd 
        --zone=public 
        --add-forward-port=port={{ dnat_port }}:proto={{ dnat_protocol }}:toport={{ dnat_port }}:toaddr={{ internal_ip_3 }}
        --permanent
        --destination-address={{ external_ip_3 }} 
      ignore_errors: yes
      
    - name: 4. firewalld ê·œì¹™ ì¬ë¡œë”© (ì˜êµ¬ ì ìš©)
      ansible.builtin.command: sudo firewall-cmd --reload
