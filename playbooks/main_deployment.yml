# autoprov/vsphere-autoprov/playbooks/main_deployment.yml
---
- name: 1. Configure Distributed Switch and Port Groups (Infrastructure Phase)
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml 
  roles:
    - dvs_config     # [1ìˆœìœ„] DVS ìƒì„± ë° DPG ìƒì„± ì‹¤í–‰

- name: 2. VM Provisioning Playbook (VMì´ ì¡´ì¬í•˜ë©´ ê±´ë„ˆëœ€)
  import_playbook: provision_vms.yml

- name: 3. Configure VyOS Router Network 
  hosts: vyos_router
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml 
  roles:
    - vyos_network

- name: 4. Deploy Nginx Application 
  hosts: linux_server
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml
  roles:
    - nginx_deployment

- name: 5. Deploy Mail Server Application (Mail ë‹´ë‹¹ì ì˜ì—­)
  hosts: mailservers
  gather_facts: no
  vars_files:
   - ../group_vars/all.yml
  roles:
   - mail_server_deployment

- name: 6. Deploy Zabbix Server Application
  hosts: zabbix_server
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml
  roles:
    - zabbix_agent_deploy
    
# -----------------------------------------------------
# 7. Zabbix Agent ë°°í¬ ë° ë°©í™”ë²½ ì„¤ì • (Nginx/Mail ì„œë²„)
# -----------------------------------------------------
- name: 7. Deploy Zabbix Agent and Configure on Mail Server
  hosts: mailservers # Mail ì„œë²„ì™€ Nginx ì„œë²„ ëª¨ë‘ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml
  vars:
    ansible_user: "{{ mail_os_user }}"
    ansible_password: "{{ mail_ssh_pass }}"
    ansible_become: yes 
  roles:
    - zabbix_agent_deploy # ğŸš¨ Agent ì„¤ì • Role í˜¸ì¶œ
    
- name: 7-5. Deploy Zabbix Agent and Configure on Nginx Servers
  hosts: linux_server # Mail ì„œë²„ì™€ Nginx ì„œë²„ ëª¨ë‘ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml
  vars:
    ansible_user: "{{ nginx_os_user }}"
    ansible_password: "{{ nginx_ssh_pass }}"
    ansible_become: yes 
  roles:
    - zabbix_agent_deploy # ğŸš¨ Agent ì„¤ì • Role í˜¸ì¶œ
# -----------------------------------------------------
# 8. VyOS SNMP ì„¤ì • ë° Zabbix Server ì ‘ê·¼ í—ˆìš©
# -----------------------------------------------------
- name: 8. Configure VyOS SNMP Monitoring
  hosts: vyos_router
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml
  vars:
    ansible_user: "{{ vyos_os_user }}"
    ansible_password: "{{ vyos_ssh_pass }}"
    ansible_connection: network_cli 
    ansible_network_os: vyos
  tasks:
    - name: Include Zabbix SNMP Configuration
      ansible.builtin.include_tasks: ../roles/vyos_network/tasks/zabbix_snmp.yml

