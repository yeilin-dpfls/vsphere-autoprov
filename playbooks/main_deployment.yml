# autoprov/vsphere-autoprov/playbooks/main_deployment.yml
---
- name: 1. Configure Distributed Switch and Port Groups (Infrastructure Phase)
  hosts: localhost
  connection: local
  gather_facts: no
  # 모든 변수를 사용하기 위해 group_vars/all.yml 파일을 강제로 로드
  vars_files:
    - ../group_vars/all.yml 
  roles:
    - dvs_config     # [1순위] DVS 생성 및 DPG 생성 실행

- name: 2. VM Provisioning Playbook (VM이 존재하면 건너뜀)
  # 이전에 실행했던 VM 생성 Playbook을 호출
  import_playbook: provision_vms.yml

- name: 3. Configure VyOS Router Network (VyOS 담당자 책임)
  hosts: vyos_router # inventory의 [vyos_router] 그룹 대상 (10.10.10.18)
  gather_facts: no
  vars_files:
    - ../group_vars/all.yml 
  roles:
    - vyos_network   # [3순위] VyOS IP, NAT, 라우팅 설정 실행

- name: 4. Prepare Linux Base OS (Nginx/Linux 담당자 책임)
  hosts: linux_server # inventory의 [linux_server] 그룹 대상
  gather_facts: no
  # Linux 담당자가 작성할 Role을 위한 틀
  roles:
    - linux_os
